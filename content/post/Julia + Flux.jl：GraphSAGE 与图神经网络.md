---
title: "Julia + Flux.jlï¼šGraphSAGE ä¸å›¾ç¥ç»ç½‘ç»œ"
date: 2022-04-23T16:19:15+08:00
tags:
  - julia
  - machine learning
---

> æ—¶éš”å¤šå¹´ï¼ŒJulia æœºå™¨å­¦ä¹ ç³»åˆ—ç»ˆäºè¿æ¥~~å¹¶ä¸å€¼å¾—æœŸå¾…çš„~~æ›´æ–°ï¼

è¶ç€æ¯•ä¸šè®¾è®¡ç ”ç©¶å›¾ç¥ç»ç½‘ç»œçš„æœºä¼šï¼Œè®©æˆ‘ä»¬æ¥èŠèŠå¦‚ä½•ç”¨ Julia å®ç°ä¸€ä¸ªç®€å•çš„å›¾ç¥ç»ç½‘ç»œï¼

<!--more-->

## èƒŒæ™¯ä»‹ç»

å¯¹ç¥ç»ç½‘ç»œæœ‰ç€åŸºæœ¬äº†è§£çš„è¯»è€…åº”è¯¥çŸ¥é“ï¼Œç¥ç»ç½‘ç»œæ¯”è¾ƒé€‚åˆå¤„ç†ä¸€äº›ç»“æ„åŒ–çš„æ•°æ® â€”â€” è¿™äº›æ•°æ®é€šå¸¸å¯ä»¥ä»¥çŸ©é˜µçš„å½¢å¼è¡¨ç¤ºï¼Œè€Œç¥ç»ç½‘ç»œåªéœ€è¦å¯¹è¿™äº›çŸ©é˜µä¸åœçš„è¿›è¡Œå¾®åˆ†ä¸ä»£æ•°è¿ç®—å°±å¯ä»¥äº†ã€‚

å¯¹è®¡ç®—æœºç§‘å­¦æœ‰ç€åŸºæœ¬äº†è§£çš„è¯»è€…ä¹Ÿåº”è¯¥çŸ¥é“ï¼Œå›¾å¹¶ä¸æ˜¯ä¸€ç§éå¸¸ç»“æ„åŒ–çš„æ•°æ®ï¼šä¸€å¼ å›¾ $\mathcal{G}$ ç”±ç‚¹é›† $\mathcal{V}$ ä¸è¾¹é›† $\mathcal{E}$ ç»„æˆï¼Œå›¾ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ä¸ä»»æ„å¤šä¸ªå…¶ä»–èŠ‚ç‚¹ç›¸è¿ï¼Œä¸å­˜åœ¨ä¸¥æ ¼è§„å¾‹çš„ç»“æ„ã€‚ä¸€äº›ç®—æ³•è¯•å›¾ä½¿ç”¨å›¾çš„é‚»æ¥çŸ©é˜µï¼ˆadjacency matrixï¼‰æ¥è¿›è¡Œè®¡ç®—ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼š

1. é‚»æ¥çŸ©é˜µæ˜¯ç¨€ç–çš„ï¼Œå¦‚ä½•åœ¨æœ‰é™çš„å†…å­˜ä¸­å¯¹è¾ƒå¤§çš„é‚»æ¥çŸ©é˜µè¿›è¡Œå­˜å‚¨å’Œè®¡ç®—æ˜¯ä¸ªéš¾é¢˜ï¼›
2. é‚»æ¥çŸ©é˜µä¸æ˜“äºæ‰©å±•ï¼Œæ–°å¢çš„å›¾èŠ‚ç‚¹æˆ–è¾¹å¾€å¾€ä¼šå¯¼è‡´é‡æ–°è®¡ç®—ï¼Œè€—è´¹æ—¶é—´ä¸èµ„æºã€‚

æœ¬æ–‡å°†ä»‹ç»ä¸€ç§åä¸º GraphSAGE[^1] çš„å›¾ç¥ç»ç½‘ç»œç®—æ³•ï¼Œå®ƒèƒ½åˆ©ç”¨å¸¸è§çš„ç¥ç»ç½‘ç»œæ¶æ„å¤„ç†å¤§é‡å›¾ç»“æ„æ•°æ®ã€‚æ­¤å¤–ï¼ŒGraphSAGE è¿˜æ˜¯ä¸€ç§å½’çº³å¼ï¼ˆinductiveï¼‰ç®—æ³•ï¼Œè€Œéä¸€ç§ç›´æ¨å¼ï¼ˆtransductiveï¼‰ç®—æ³• â€”â€” å½’çº³å¼å­¦ä¹ ç®—æ³•èƒ½æœ‰æ•ˆåœ°æ³›åŒ–åˆ°æœªçŸ¥çš„æ•°æ®ä¸Šï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å›¾ä¸­å‡ºç°æ–°å¢çš„èŠ‚ç‚¹æˆ–è¾¹æ—¶ï¼ŒGraphSAGE æ— éœ€é‡æ–°è®­ç»ƒå°±èƒ½å¾—åˆ°æ¯”è¾ƒå¥½çš„ç»“æœã€‚

## é—®é¢˜è®¾å®š

ä¸ºäº†ä»‹ç»å›¾ç¥ç»ç½‘ç»œï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆå¼•å…¥ä¸€ä»½å›¾æ•°æ®é›† CORA[^2]ã€‚CORA æ˜¯ä¸€ä»½è®ºæ–‡å¼•ç”¨ç½‘ç»œæ•°æ®é›†ï¼šåœ¨è¿™ä»½æ•°æ®é›†ä¸­ï¼Œæ¯ä¸€ç¯‡è®ºæ–‡æ„æˆå›¾çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œè®ºæ–‡ä¹‹é—´çš„å¼•ç”¨å…³ç³»åˆ™å½¢æˆå›¾çš„æ— å‘è¾¹ã€‚æ­¤å¤–ï¼Œæ•°æ®é›†è¿˜é‡‡ç”¨è¯è¢‹ï¼ˆbag-of-wordsï¼‰æ¨¡å‹ä¸ºæ¯ä¸€ç¯‡è®ºæ–‡æ„å»ºä¸€ä¸ªå½¢å¦‚ $1433 \times 1$ çš„ç‰¹å¾å‘é‡ï¼šè¯è¢‹è€ƒè™‘ 1433 ä¸ªå½¼æ­¤ä¸åŒçš„å•è¯ï¼Œå¦‚æœè®ºæ–‡ä¸­åŒ…å«è¯¥å•è¯åˆ™ç‰¹å¾å€¼å– 1ï¼Œåä¹‹å– 0ã€‚

è€Œæˆ‘ä»¬çš„ä»»åŠ¡ï¼Œåˆ™æ˜¯è¦åˆ©ç”¨è®ºæ–‡èŠ‚ç‚¹çš„ç‰¹å¾å‘é‡ä¸èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œæ¥é¢„æµ‹æ¯ä¸ªè®ºæ–‡èŠ‚ç‚¹çš„ç±»å‹ã€‚æ•°æ®é›†ä¸­å…±åŒ…å«ä¸ƒä¸ªç±»å‹çš„è®ºæ–‡ï¼Œæ¯ç¯‡è®ºæ–‡æœ‰ä¸”åªæœ‰ä¸€ä¸ªç±»å‹ã€‚å¦‚æœä¸è€ƒè™‘å›¾æ•°æ®ç»“æ„ï¼Œè¿™çœ‹èµ·æ¥å°±æ˜¯ä¸ªå¾ˆç®€å•çš„åˆ†ç±»ä»»åŠ¡ï¼Œå¯¹å§ï¼Ÿ

åœ¨ Julia è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `MLDatasets` åŒ…æ¥æ–¹ä¾¿åœ°ä¸‹è½½ CORA æ•°æ®é›†ï¼š

```julia
using MLDatasets: Cora
data = Cora.dataset()
```

## å¤šå±‚æ„ŸçŸ¥æœº

ã€Œå¦‚æœä¸è€ƒè™‘å›¾æ•°æ®ç»“æ„ã€å…¶å®æ˜¯ä¸ªä¸é”™çš„èµ·æ­¥æ€è·¯ã€‚è‡³å°‘æˆ‘ä»¬å¯ä»¥å…ˆè¯•è¯•ï¼Œåœ¨å¿½ç•¥å›¾èŠ‚ç‚¹ä¹‹é—´å…³è”çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½è¾¾åˆ°æ€æ ·çš„ç²¾åº¦ã€‚

é¦–å…ˆä½¿ç”¨å®šä¹‰ä¸€ä¸ªç®€å•çš„å¤šå±‚æ„ŸçŸ¥æœºï¼ˆMulti-Layer Perceptronï¼Œå³å…¨è¿æ¥ç¥ç»ç½‘ç»œï¼‰ï¼Œè¾“å‡ºå±‚ä½¿ç”¨ `softmax` æ¿€æ´»ã€‚

```julia
using Flux

model = Chain(
    Dense(1433, 256),
    Dense(256, 7),
    softmax,
)
```

å®šä¹‰ç²¾ç¡®ç‡ï¼ˆaccuracyï¼‰å‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç›´è§‚åœ°æ„ŸçŸ¥æ¨¡å‹çš„æ€§èƒ½ã€‚æŸå¤±ï¼ˆlossï¼‰å‡½æ•°ä½¿ç”¨äº¤å‰ç†µï¼ˆcross entropyï¼‰ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨éªŒè¯æ•°æ®é›†æ¥å¯¹æ¨¡å‹è®­ç»ƒè¿›è¡Œæ—©åœï¼ˆearly stoppingï¼‰ä»¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚

```julia
acc(x, y) = mean(Flux.onecold(model(x)) .== Flux.onecold(y))
loss(x, y) = Flux.crossentropy(model(x), y)

es = let f = () -> loss(val_x, val_y)
    Flux.early_stopping(f, 3; init_score=f())
end
```

è®­ç»ƒ 32 è½®ååœæ­¢ï¼Œè®­ç»ƒé›†ç²¾ç¡®åº¦ 100%ï¼Œæµ‹è¯•é›†ç²¾ç¡®åº¦ 57.3%ã€‚

```julia
Flux.@epochs 10000 begin
    Flux.train!(loss, Flux.params(model), dataset, opt)
    es() && break
end

@show acc(train_x, train_y)
@show loss(train_x, train_y)
@show acc(test_x, test_y)
@show loss(test_x, test_y)
```

ä¸è€ƒè™‘å›¾èŠ‚ç‚¹ä¹‹é—´çš„å…³è”ï¼Œæœç„¶è¿˜æ˜¯æ— æ³•å–å¾—æ¯”è¾ƒå¥½çš„ç²¾ç¡®åº¦å•Š ğŸ¤”

## GraphSAGE

æ—¢ç„¶æ— è§†å›¾ç»“æ„æ— æ³•å–å¾—è¾ƒå¥½çš„æˆæœï¼Œé‚£å°±è®©æˆ‘ä»¬å°è¯•å¼•å…¥ GraphSAGE å›¾ç¥ç»ç½‘ç»œç®—æ³•å§ï¼

### åŸç†

GraphSAGE çš„æ ¸å¿ƒæ€æƒ³éå¸¸ä¼˜é›…ç®€æ´ã€‚ä¸ªäººæ€»ç»“èµ·æ¥å°±æ˜¯ï¼šå›¾ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾éƒ½å—åˆ°å‘¨è¾¹èŠ‚ç‚¹çš„å½±å“ï¼Œè·ç¦»è¶Šè¿‘å½±å“è¶Šå¤§ã€‚å› æ­¤ï¼Œå›¾èŠ‚ç‚¹å¯ä»¥é€šè¿‡ä¸æ–­èšåˆï¼ˆaggregateï¼‰é‚»å±…èŠ‚ç‚¹çš„ç‰¹å¾æ¥å¢å¼ºè‡ªèº«çš„ç‰¹å¾ â€”â€” é€šè¿‡å¤šè½®èšåˆï¼ŒèŠ‚ç‚¹ç‰¹å¾ä¸ä»…åŒ…å«è‡ªèº«çš„ç‰¹å¾ä¿¡æ¯ï¼Œè¿˜å°†åŒ…å«èŠ‚ç‚¹åœ¨å›¾æ‹“æ‰‘ç»“æ„ä¸­çš„ä½ç½®ä¿¡æ¯ã€ä»¥åŠä¸å‘¨è¾¹èŠ‚ç‚¹çš„å…³ç³»ä¿¡æ¯ã€‚

ç”¨æ›´ä¸ºå½¢å¼åŒ–çš„è¯­è¨€è¡¨è¿°å¦‚ä¸‹ï¼šç»™å®šå›¾ $\mathcal{G}(\mathcal{V},\mathcal{E})$ï¼Œå‡è®¾æˆ‘ä»¬è¦è¿›è¡Œ $K$ è½®èšåˆã€‚å¯¹äº $k\in1\dots K$ï¼Œ$v\in\mathcal{V}$ï¼Œä»¤ $h_v^0$ ä¸ºèŠ‚ç‚¹ $v$ çš„åŸå§‹ç‰¹å¾ï¼Œ$h_v^k$ ä¸ºèŠ‚ç‚¹ $v$ åœ¨ç¬¬ $k$ è½®ä¸­èšåˆå¾—åˆ°çš„ç‰¹å¾ï¼Œ$\mathcal{N}(v)$ ä¸º $v$ é‚»å±…èŠ‚ç‚¹çš„é›†åˆï¼Œ$\mathbf{W}$ ä¸ºæƒé‡çŸ©é˜µï¼Œ$\sigma$ ä¸ºæ¿€æ´»å‡½æ•°ï¼Œåˆ™

<tex>
$$
\begin{aligned}
&\mathbf{h}_{\mathcal{N}(v)}^k=\operatorname{\small{AGGREGATE}}_k(\big\{\mathbf{h}_u^{k-1},\ u\in\mathcal{N(v)}\big\})
\newline
&\mathbf{h}_v^k=\sigma(\mathbf{W}\cdot\operatorname{\small{CONCAT}}(\mathbf{h}_v^{k-1},\ \mathbf{h}_{\mathcal{N}(v)}^{k}))
\end{aligned}
$$
</tex>

GraphSAGE ç®—æ³•åœ¨è¿›è¡Œèšåˆæ—¶ä¼šä¾æ¬¡éå†ç‚¹é›† $v\in\mathcal{V}$ï¼Œè¿™æ ·åšå¯è¡Œä½†æ€§èƒ½ä¸ä½³ã€‚ç¥ç»ç½‘ç»œé€šå¸¸ä¼šåˆ©ç”¨ mini-batch æŠ€æœ¯æ¥åŠ é€Ÿè®¡ç®—ï¼Œå³ä¸€æ¬¡æ€§æ‰¹é‡å¤„ç†å¤šä¸ªæ ·æœ¬ã€‚å¯¹ä¸Šè¿° GraphSAGE ç®—æ³•ç¨ä½œä¿®æ”¹ï¼Œä¹Ÿèƒ½åˆ©ç”¨ mini-batch åŠ é€Ÿè®¡ç®—ï¼šå¯¹äº $k\in1\dots K$ï¼Œå‡è®¾æˆ‘ä»¬è¦æ‰¹é‡å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹é›†åˆ $\mathcal{B}^0\subset\mathcal{V}$ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç‰¹å¾å½¢å¦‚ $L\times1$ï¼Œæ•´ä¸ªæ‰¹çš„èŠ‚ç‚¹ç‰¹å¾å½¢å¦‚ $L\times|\mathcal{B}^0|$ã€‚ä»¤ $\mathcal{N}(v)$ ä¸ºé‚»å±…èŠ‚ç‚¹é‡‡æ ·å‡½æ•°ï¼Œé‡‡æ ·å‡½æ•°ä¼šä»èŠ‚ç‚¹ $v$ çš„é‚»å±…èŠ‚ç‚¹ä¸­æŠ½å– $n$ ä¸ªæ ·æœ¬ï¼Œå¦‚æœ

- é‚»å±…èŠ‚ç‚¹æ•°é‡å¤§äºç­‰äº $n$ ä¸ªï¼Œåˆ™ä¸å¸¦æ”¾å›åœ°æŠ½å– $n$ ä¸ªæ ·æœ¬ï¼›
- é‚»å±…èŠ‚ç‚¹æ•°é‡å°‘äº $n$ ä¸ªï¼Œåˆ™æœ‰æ”¾å›åœ°é‡‡æ ·ï¼Œç›´åˆ°è·å¾— $n$ ä¸ªæ ·æœ¬ã€‚

> ä¹‹æ‰€ä»¥é€‰æ‹©é‡‡æ ·ï¼Œè€Œéç›´æ¥ä½¿ç”¨æ‰€æœ‰é‚»å±…èŠ‚ç‚¹çš„é›†åˆï¼Œæ˜¯å› ä¸ºç¡®ä¿é‡‡æ ·æ•°æ’ä¸º $n$ è‡³å…³é‡è¦ â€”â€” ä¸‹æ–‡ä¼šè¯´åˆ°ï¼Œå¦‚æœé‡‡æ ·æ•°ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬å°±æ— æ³•åˆ©ç”¨çŸ©é˜µè¿ç®—åŠ é€ŸæŠ€æœ¯ï¼Œæ‰¹é‡å¤„ç†ä¹Ÿå°±å¤±å»äº†æå‡æ€§èƒ½çš„æ„ä¹‰ã€‚

æˆ‘ä»¬å¯¹ $\mathcal{B}^0$ é›†åˆä¸­æ‰€æœ‰èŠ‚ç‚¹çš„é‚»å±…èŠ‚ç‚¹è¿›è¡Œé‡‡æ ·ï¼Œé‡‡æ ·ç»“æœæ”¾å…¥ $\mathcal{B}^1$ é›†åˆï¼Œå¯¹ $\mathcal{B}^k$ é‡‡æ ·æ”¾å…¥ $\mathcal{B}^{k+1}$ é›†åˆï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°å–å¾— $\mathcal{B}^K$ é›†åˆã€‚ç”±äºé‡‡æ ·æ•°æ’ä¸º $n$ï¼Œæˆ‘ä»¬æœ‰ $|\mathcal{B}^k|\times n=|\mathcal{B}^{k+1}|$ã€‚

<tex>
$$
\begin{aligned}
&\mathbf{h}_{\mathcal{N}(\mathcal{B}^k)}^k=\operatorname{\small{AGGREGATE}}_k(\mathbf{h}_{\mathcal{B}^{k+1}}^{k-1})
\newline
&\mathbf{h}_{\mathcal{B}^k}^k=\sigma(\mathbf{W}\cdot\operatorname{\small{CONCAT}}(\mathbf{h}_{\mathcal{B}^k}^{k-1},\ \mathbf{h}_{\mathcal{N}(\mathcal{B}^k)}^k))
\end{aligned}
$$
ç”±äº $\mathbf{h}_{\mathcal{B}^{k+1}}^{k-1}$ å½¢å¦‚ $L\times|\mathcal{B}^{k+1}|$ï¼Œå¯ä»¥é€šè¿‡å˜å½¢è½¬æ¢ä¸º $L\times n\times|\mathcal{B}^k|$ï¼Œå°†èšåˆå‡½æ•° $\operatorname{\small{AGGREGATE}}_k$ å¯¹å¼ é‡æ¯ $n$ ä¸ªä¸€ç»„æ‰¹é‡èšåˆï¼Œå³å¯å¾—åˆ°é‚»å±…èŠ‚ç‚¹å½¢å¦‚ $L\times|\mathcal{B}^k|$ çš„èšåˆç‰¹å¾è¡¨ç¤ºã€‚å°†è¯¥èšåˆç‰¹å¾ $h^k_{\mathcal{N}(\mathcal{B}^k)}$ ä¸å½“å‰æ‰¹è‡ªèº«ç‰¹å¾ $\mathbf{h}_{\mathcal{B}^k}^k$ ç»“åˆï¼Œå†ä¸ç‰¹å¾çŸ©é˜µ $\mathbf{W}$ ç›¸ä¹˜å³å¯ã€‚

</tex>

### å®ç°

> æ•´è¿™ä¹ˆå¤šæ•°å­¦å…¬å¼ï¼Œå’±ä¹ŸæŒºæ™•çš„ï¼Œä¸å¦‚ç›´æ¥ä¸Šä»£ç å§ï¼

é¦–å…ˆå®ç° `GraphSampler` é‡‡æ ·å±‚ï¼Œå¯¹è¾“å…¥çš„æ‰¹ $\mathcal{B}^0$ è¿›è¡Œé‡‡æ ·ï¼Œäº§ç”Ÿ $\mathcal{B}^1\cdots\mathcal{B}^K$ã€‚è¾“å…¥ `x` å³ä¸º $\mathcal{B}^0$ï¼ŒåŒ…å«å½“å‰æ‰¹æ‰€æœ‰èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ã€‚æˆ‘ä»¬ä¼šå¾ªç¯ $K$ æ¬¡ï¼Œä¾æ¬¡ç”Ÿæˆ $\mathcal{B}^1\cdots\mathcal{B}^K$ï¼ˆå³ `ids`ï¼‰ ä¸ $\mathbf{h}^0_{\mathcal{B}^0}\cdots\mathbf{h}^0_{\mathcal{B}^K}$ï¼ˆå³ `layers`ï¼‰ã€‚

```julia
import Zygote
using StatsBase: sample

struct GraphSampler
    K::Integer
    n::Integer
    
    GraphSampler(; K::Integer, n::Integer) = new(K, n)
end

function (g::GraphSampler)(x::AbstractArray)
    Zygote.ignore() do
        ids = x
        layers = [data.node_features[:, ids]]
        for k in 1:g.K
            ids = vcat([sample(
                data.adjacency_list[u], g.n,
                replace=length(data.adjacency_list[u]) < g.n
            ) for u in ids]...)
            push!(layers, data.node_features[:, ids])
        end
        
        layers
    end
end
```

ç”±äºé‡‡æ ·å±‚æ²¡æœ‰è¿›è¡Œä»»ä½•å‚æ•°è¿ç®—ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦å¾®åˆ†ï¼Œæˆ‘ä»¬å°†æ•´ä¸ªå±‚ç”¨ [`Zygote.ignore`](https://fluxml.ai/Zygote.jl/latest/utils/#Zygote.ignore) åŒ…è£¹èµ·æ¥ï¼Œè¡¨ç¤ºä¸è¦å¯¹è¿™ä¸€æ®µä»£ç è¿›è¡Œè‡ªåŠ¨å¾®åˆ†ï¼ˆauto differentiationï¼‰ã€‚

å…¶æ¬¡å®ç° `MeanAggregator` èšåˆå±‚ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨å¹³å‡èšåˆã€‚ç”±äºæ¯ä¸ªèšåˆå±‚åªè¿›è¡Œä¸€æ¬¡èšåˆï¼Œæœ€ç»ˆå›¾ç¥ç»ç½‘ç»œä¸­åº”è¯¥æœ‰ $K$ ä¸ªèšåˆå±‚ã€‚ç¬¬ $k\in1\cdots K$ ä¸ªèšåˆå±‚çš„è¾“å…¥ä¸º $\mathbf{h}^{k-1}\_{\mathcal{B}^0}\cdots\mathbf{h}^{k-1}\_{\mathcal{B}^{K-k+1}}$ï¼Œè¾“å‡ºä¸º $\mathbf{h}^k_{\mathcal{B}^0}\cdots\mathbf{h}^k_{\mathcal{B}^{K-k}}$ã€‚å› æ­¤ï¼Œå½“å‰æ‰¹ $\mathcal{B}^0$ é€šè¿‡ä¸€ä¸ªé‡‡æ ·å±‚ä¸ $K$ ä¸ªèšåˆå±‚åä¼šè¾“å‡º $h^K_{\mathcal{B}^0}$ã€‚

```julia
struct MeanAggregator
    w::Dense
    
    MeanAggregator((in, out)::Pair{<:Integer, <:Integer}, Ïƒ::F) where {F} = new(Dense(in * 2 => out, Ïƒ))
end

function (m::MeanAggregator)(layers::Vector{Matrix{Float32}})
    [
        cat(
            layers[i],
            layers[i + 1] |>
                x -> reshape(x, (size(layers[i], 1), :, size(layers[i], 2))) |>
                x -> mean(x, dims=2)[:, 1, :],
            dims=1
        ) |> m.w
        for i in 1:length(layers) - 1
    ]
end

Flux.@functor MeanAggregator
```

æœ€ç»ˆå›¾ç¥ç»ç½‘ç»œç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š

```julia
model = Chain(
    GraphSampler(K=2, n=8),
    MeanAggregator(1433 => 512, relu),
    MeanAggregator(512 => 256, relu),
    x -> x[1],
    Dense(256, 7),
    softmax
)
```

åœ¨å…¶ä»–è®¾ç½®å‡ä¸æ”¹å˜çš„æƒ…å†µä¸‹ï¼Œè®­ç»ƒ 33 è½®ååœæ­¢ï¼Œè®­ç»ƒé›†ç²¾ç¡®åº¦ 100%ï¼Œæµ‹è¯•é›†ç²¾ç¡®åº¦ 78.2%ï¼Œè¾ƒåŸæ¥ç²¾ç¡®åº¦æå‡è¶…è¿‡ 20%ã€‚è¿™ä¸ªç»“æœè¿˜æ˜¯æ¯”è¾ƒä»¤äººæ»¡æ„çš„ã€‚

å®Œæ•´ä»£ç æ”¾åœ¨è¿™ä¸ª Jupyter Notebook [ä¸Šé¢](https://gist.github.com/queensferryme/1526acfd04a29b86fbeeaf5c09db17e1)ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹ã€‚

---

[^1]: Hamilton, W., Ying, Z., & Leskovec, J. (2017). Inductive representation learning on large graphs. *Advances in neural information processing systems*, *30*.
[^2]: https://relational.fit.cvut.cz/dataset/CORA
